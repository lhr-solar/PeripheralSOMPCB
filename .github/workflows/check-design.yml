name: Validate Design Files, ERC/DRC, and 3D Model Check

on:
  pull_request:
    paths:
      - 'pcb.json'
      - 'bom/**'
      - '3dmodel/**'
      - '*.kicad_sch'
      - '*.kicad_pcb'

permissions:
  contents: write
  pull-requests: write

jobs:
  validate-files:
    runs-on: ubuntu-latest
    outputs:
      schematic: ${{ steps.extract.outputs.schematic }}
      layout: ${{ steps.extract.outputs.layout }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate pcb.json and extract paths
        id: extract
        run: |
          set -euo pipefail
          json_file="pcb.json"
          [ -f "$json_file" ] || { echo "‚ùå pcb.json not found."; exit 1; }

          schematic=$(jq -r '.["PCB Schematic"]' "$json_file")
          layout=$(jq -r '.["PCB Layout"]' "$json_file")

          for file in "$schematic" "$layout"; do
            if [ -z "$file" ] || [ "$file" = "null" ] || [ ! -f "$file" ]; then
              echo "‚ùå Missing or invalid file path: $file"
              exit 1
            fi
          done

          echo "schematic=$schematic" >> "$GITHUB_OUTPUT"
          echo "layout=$layout" >> "$GITHUB_OUTPUT"

  run-erc:
    needs: validate-files
    runs-on: ubuntu-latest
    outputs:
      erc_errors: ${{ steps.parse.outputs.erc_errors }}
    steps:
      - uses: actions/checkout@v4

      - name: Run KiCad ERC
        continue-on-error: true
        uses: actions-for-kicad/kicad-actions@v1-k9.0
        with:
          schematic_file_name: ${{ needs.validate-files.outputs.schematic }}
          run_erc: true

      - name: Parse ERC report (errors only)
        id: parse
        run: |
          if [ -f erc.rpt ]; then
            ERRORS=$(grep -i "; error" erc.rpt || true)
            echo "erc_errors<<EOF" >> $GITHUB_OUTPUT
            echo "${ERRORS}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ERC-Report
          path: erc.rpt

  run-drc:
    needs: validate-files
    runs-on: ubuntu-latest
    outputs:
      drc_errors: ${{ steps.parse.outputs.drc_errors }}
    steps:
      - uses: actions/checkout@v4

      - name: Run KiCad DRC
        continue-on-error: true
        uses: actions-for-kicad/kicad-actions@v1-k9.0
        with:
          pcb_file_name: ${{ needs.validate-files.outputs.layout }}
          run_drc: true

      - name: Parse DRC report (errors only)
        id: parse
        run: |
          if [ -f drc.rpt ]; then
            ERRORS=$(grep -i "error" drc.rpt || true)
            echo "drc_errors<<EOF" >> $GITHUB_OUTPUT
            echo "${ERRORS}" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: DRC-Report
          path: drc.rpt

  check-and-generate-3dmodel:
    needs: validate-files
    runs-on: ubuntu-latest
    outputs:
      generated: ${{ steps.check.outputs.generated }}
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Check for missing board-level STEP model
        id: check
        run: |
          mkdir -p 3dmodel
          if ! find 3dmodel -maxdepth 1 -type f -name '*.step' | grep -q .; then
            echo "No STEP models found ‚Äî will generate one..."
            echo "generated=true" >> $GITHUB_OUTPUT
          else
            echo "generated=false" >> $GITHUB_OUTPUT
          fi

      - name: Install KiCad 3D model libraries
        run: |
          sudo apt-get install -y kicad-packages3d

      - name: Generate board STEP model with kicad-actions
        if: steps.check.outputs.generated == 'true'
        uses: actions-for-kicad/kicad-actions@v1-k9.0
        continue-on-error: true
        with:
          pcb_file_name: ${{ needs.validate-files.outputs.layout }}
          pcb_output_step: true

      - name: Move STEP to 3dmodel folder
        if: steps.check.outputs.generated == 'true'
        run: |
          mkdir -p 3dmodel
          mv pcb.step 3dmodel/pcb.step || echo "STEP file not found after generation"

      - name: Commit generated model
        if: steps.check.outputs.generated == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add 3dmodel/*.step
          git commit -m "Add missing board STEP model"
          git push origin HEAD:${{ github.event.pull_request.head.ref }}

  post-comment:
    needs: [run-erc, run-drc, check-and-generate-3dmodel]
    runs-on: ubuntu-latest
    steps:
      - name: Post summary comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const erc = `${{ needs.run-erc.outputs.erc_errors }}`.trim();
            const drc = `${{ needs.run-drc.outputs.drc_errors }}`.trim();
            const generated = '${{ needs.check-and-generate-3dmodel.outputs.generated }}' === 'true';

            let body = "## üõ†Ô∏è KiCad CI Report\n";

            if (erc) {
              body += `### ERC Errors\n\`\`\`\n${erc}\n\`\`\`\n`;
            } else {
              body += "‚úÖ No ERC errors found.\n";
            }

            if (drc) {
              body += `\n### DRC Errors\n\`\`\`\n${drc}\n\`\`\`\n`;
            } else {
              body += "\n‚úÖ No DRC errors found.\n";
            }

            if (generated) {
              body += "\n‚úÖ Missing board-level STEP model was auto-generated and committed to this PR.\n";
            } else {
              body += "\n‚úÖ Board-level STEP model already present.\n";
            }

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
