name: Validate Design Files and Run KiCad Checks

on:
  pull_request:
    paths:
      - 'pcb.json'
      - 'bom/**'
      - '3dmodel/**'
      - '*.kicad_sch'
      - '*.kicad_pcb'
  workflow_dispatch:

jobs:
  validate-files:
    runs-on: ubuntu-latest
    outputs:
      schematic: ${{ steps.extract.outputs.schematic }}
      layout: ${{ steps.extract.outputs.layout }}
    steps:
      - uses: actions/checkout@v4

      - name: Validate pcb.json and extract paths
        id: extract
        run: |
          set -euo pipefail
          json_file="pcb.json"
          [ -f "$json_file" ] || { echo "❌ pcb.json not found."; exit 1; }

          bom=$(jq -r '.BOM' "$json_file")
          model=$(jq -r '.["3D Model"]' "$json_file")
          schematic=$(jq -r '.["PCB Schematic"]' "$json_file")
          layout=$(jq -r '.["PCB Layout"]' "$json_file")

          for file in "$bom" "$model" "$schematic" "$layout"; do
            if [ -z "$file" ] || [ "$file" = "null" ] || [ ! -f "$file" ]; then
              echo "❌ Missing or invalid file path: $file"
              exit 1
            fi
          done

          echo "schematic=$schematic" >> "$GITHUB_OUTPUT"
          echo "layout=$layout" >> "$GITHUB_OUTPUT"

          echo "✅ pcb.json validated."

  run-erc:
    needs: validate-files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run KiCad ERC
        uses: actions-for-kicad/kicad-actions@v1-k9.0
        with:
          schematic_file_name: ${{ needs.validate-files.outputs.schematic }}
          run_erc: true

      - name: Parse ERC report (errors only)
        id: parse
        run: |
          fail=0
          if [ -f erc.rpt ] && grep -qi "; error" erc.rpt; then
            echo "❌ ERC errors found:"
            grep -i "; error" erc.rpt
            fail=1
          fi
          echo "fail=$fail" >> $GITHUB_OUTPUT

      - name: Upload ERC report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ERC-Report
          path: erc.rpt

      - name: Fail if ERC errors were found
        if: steps.parse.outputs.fail == '1'
        run: exit 1

  run-drc:
    needs: validate-files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run KiCad DRC
        uses: actions-for-kicad/kicad-actions@v1-k9.0
        with:
          pcb_file_name: ${{ needs.validate-files.outputs.layout }}
          run_drc: true

      - name: Parse DRC report (errors only)
        id: parse
        run: |
          fail=0
          if [ -f drc.rpt ] && grep -qi "error" drc.rpt; then
            echo "❌ DRC errors found:"
            grep -i "error" drc.rpt
            fail=1
          fi
          echo "fail=$fail" >> $GITHUB_OUTPUT

      - name: Upload DRC report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: DRC-Report
          path: drc.rpt

      - name: Fail if DRC errors were found
        if: steps.parse.outputs.fail == '1'
        run: exit 1
