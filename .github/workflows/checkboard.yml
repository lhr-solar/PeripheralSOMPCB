name: Validate Design Files and Run KiCad Checks

on:
  workflow_dispatch:
  pull_request:
  push:
    
    paths:
      - '**/*.json'
      - '**/*.kicad_sch'
      - '**/*.kicad_pcb'
  
 

jobs:
  validate-files:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Validate JSON and file paths
        run: |
          json_file=$(find . -name '*.json' | head -n 1)
          if [ -z "$json_file" ]; then
            echo "‚ùå No JSON file found."
            exit 1
          fi

          echo "üîç Checking $json_file..."

          bom=$(jq -r '.BOM' "$json_file")
          model=$(jq -r '.["3D Model"]' "$json_file")
          schematic=$(jq -r '.["PCB Schematic"]' "$json_file")
          layout=$(jq -r '.["PCB Layout"]' "$json_file")

          for file in "$bom" "$model" "$schematic" "$layout"; do
            if [ "$file" == "null" ] || [ ! -f "$file" ]; then
              echo "‚ùå Missing or invalid file path: $file"
              exit 1
            fi
          done

          echo "‚úÖ All required files are present."

  run-kicad-checks:
    needs: validate-files
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Run KiCad ERC/DRC
        uses: actions-for-kicad/kicad-actions@v1-k9.0
        with:
          schematic_file_name: pcb/example.kicad_sch
          run_erc: true
          pcb_file_name: pcb/example.kicad_pcb
          run_drc: true
          schematic_output_pdf: true
          pcb_output_gerbers_and_drill: true
          pcb_output_image: true

      - name: Upload ERC Report
        uses: actions/upload-artifact@v4
        with:
          name: ERC Report
          path: erc.rpt

      - name: Upload DRC Report
        uses: actions/upload-artifact@v4
        with:
          name: DRC Report
          path: drc.rpt
          
      - name: Check ERC/DRC Reports for Errors
        run: |
          fail=0

          if grep -q "Error:" erc.rpt; then
            echo "‚ùå ERC errors found:"
            grep "Error:" erc.rpt
            fail=1
          fi

          if grep -q "DRC errors" drc.rpt; then
            echo "‚ùå DRC errors found:"
            grep "DRC errors" drc.rpt
            fail=1
          fi

          if [ "$fail" -eq 1 ]; then
            echo "‚ùå Design checks failed. Fix ERC/DRC issues before merging."
            exit 1
          else
            echo "‚úÖ No ERC/DRC errors found."
          fi

